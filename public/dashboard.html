<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PT Nira Medika</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <a href="dashboard.html">Dashboard</a>
            <a href="planner.html">Planner</a>
        </div>
        <div class="nav-right">
            <span id="user-info"></span>
            <a href="/logout">Logout</a>
        </div>
    </div>
    <div class="container">
        <h1>Dashboard</h1>
        <div class="card-container">
            <div class="card">
                <h2>Check-in</h2>
                <p>Click the button to check-in.</p>
                <button id="checkin-btn">Check-in</button>
            </div>
            <div class="card">
                <h2>Planner</h2>
                <p>View and manage your tasks.</p>
                <a href="planner.html">Go to Planner</a>
            </div>
            <div class="card">
                <h2>Charts</h2>
                <canvas id="checkinChart"></canvas>
            </div>
        </div>

        <div class="checkin-history">
            <h2>Your Check-in History</h2>
            <table id="checkin-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Check-in data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let checkinChart;

        // Fungsi untuk mengambil data pengguna dan check-in
        async function initializeDashboard() {
            await fetchUserData();
            await fetchCheckins();
        }

        // Mengambil data pengguna dari server
        async function fetchUserData() {
            try {
                const response = await fetch('/api/user');
                if (!response.ok) {
                    // Jika tidak terotentikasi, redirect ke halaman login
                    window.location.href = '/login.html';
                    return;
                }
                const user = await response.json();
                displayUserInfo(user);
            } catch (error) {
                console.error('Error fetching user data:', error);
                window.location.href = '/login.html';
            }
        }

        // Menampilkan informasi pengguna di navbar
        function displayUserInfo(user) {
            const userInfoSpan = document.getElementById('user-info');
            userInfoSpan.innerHTML = `
                <img src="${user.picture}" class="profile-pic" alt="Profile Picture">
                <span>Welcome, ${user.name}</span>
            `;
        }

        // Event listener untuk tombol check-in
        document.getElementById('checkin-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/checkin', { method: 'POST' });
                if (response.ok) {
                    alert('Check-in successful!');
                    fetchCheckins(); // Muat ulang data check-in
                } else {
                    alert('Check-in failed.');
                }
            } catch (error) {
                console.error('Error during check-in:', error);
                alert('An error occurred during check-in.');
            }
        });

        // Mengambil data check-in dari server
        async function fetchCheckins() {
            try {
                const response = await fetch('/checkins');
                const checkins = await response.json();
                populateTable(checkins);
                renderChart(checkins);
            } catch (error) {
                console.error('Error fetching check-ins:', error);
            }
        }

        // Mengisi tabel riwayat check-in
        function populateTable(checkins) {
            const tableBody = document.querySelector('#checkin-table tbody');
            tableBody.innerHTML = ''; // Hapus data lama

            checkins.forEach(checkin => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${new Date(checkin.timestamp).toLocaleString()}</td>`;
                tableBody.appendChild(row);
            });
        }

        // Merender grafik check-in
        function renderChart(checkins) {
            const ctx = document.getElementById('checkinChart').getContext('2d');
            const checkinsByDay = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateString = d.toISOString().split('T')[0];
                checkinsByDay[dateString] = 0;
            }

            checkins.forEach(checkin => {
                const dateString = new Date(checkin.timestamp).toISOString().split('T')[0];
                if (checkinsByDay.hasOwnProperty(dateString)) {
                    checkinsByDay[dateString]++;
                }
            });

            const chartData = {
                labels: Object.keys(checkinsByDay).map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short'})),
                datasets: [{
                    label: 'Check-ins per Day',
                    data: Object.values(checkinsByDay),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            };

            if(checkinChart) {
                checkinChart.destroy();
            }

            checkinChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // Panggil fungsi inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
