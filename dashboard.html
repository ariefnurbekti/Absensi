<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PT Nira Medika</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="navbar">
        <a href="dashboard.html">Dashboard</a>
        <a href="planner.html">Planner</a>
        <a href="#" id="logout-btn">Logout</a>
    </div>
    <div class="container">
        <h1>Dashboard</h1>
        <div class="card-container">
            <div class="card">
                <h2>Check-in</h2>
                <p>Click the button to check-in.</p>
                <button id="checkin-btn">Check-in</button>
            </div>
            <div class="card">
                <h2>Planner</h2>
                <p>View and manage your tasks.</p>
                <a href="planner.html">Go to Planner</a>
            </div>
            <div class="card">
                <h2>Charts</h2>
                <canvas id="checkinChart"></canvas>
            </div>
        </div>

        <div class="checkin-history">
            <h2>Check-in History</h2>
            <table id="checkin-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Check-in data will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let checkinChart;

        document.getElementById('checkin-btn').addEventListener('click', async () => {
            // A real app would get the username from the session
            const username = localStorage.getItem('username'); 
            if (!username) {
                 alert('You must be logged in to check in.');
                 window.location.href = 'login.html';
                 return;
            }

            try {
                const response = await fetch('/checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                if (response.ok) {
                    alert('Check-in successful!');
                    fetchCheckins(); // Refresh the list and chart
                } else {
                    alert('Check-in failed.');
                }
            } catch (error) {
                console.error('Error during check-in:', error);
                alert('An error occurred during check-in.');
            }
        });

        async function fetchCheckins() {
            try {
                const response = await fetch('/checkins');
                const checkins = await response.json();

                populateTable(checkins);
                renderChart(checkins);

            } catch (error) {
                console.error('Error fetching check-ins:', error);
            }
        }

        function populateTable(checkins) {
            const tableBody = document.querySelector('#checkin-table tbody');
            tableBody.innerHTML = ''; // Clear existing data

            checkins.forEach(checkin => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${checkin.username}</td>
                    <td>${new Date(checkin.timestamp).toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderChart(checkins) {
            const ctx = document.getElementById('checkinChart').getContext('2d');
            
            // Process data for the chart
            const checkinsByDay = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateString = d.toISOString().split('T')[0];
                checkinsByDay[dateString] = 0;
            }

            checkins.forEach(checkin => {
                const dateString = new Date(checkin.timestamp).toISOString().split('T')[0];
                if (checkinsByDay.hasOwnProperty(dateString)) {
                    checkinsByDay[dateString]++;
                }
            });

            const chartData = {
                labels: Object.keys(checkinsByDay).map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short'})),
                datasets: [{
                    label: 'Check-ins per Day',
                    data: Object.values(checkinsByDay),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            };

            if(checkinChart) {
                checkinChart.destroy();
            }

            checkinChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Store username on login for the demo
        const loginForm = document.querySelector('form[action="/login"]');
        if (loginForm) {
            loginForm.addEventListener('submit', () => {
                const usernameInput = document.getElementById('username');
                if(usernameInput) {
                    localStorage.setItem('username', usernameInput.value);
                }
            });
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        });

        // Fetch initial check-in data when the page loads
        document.addEventListener('DOMContentLoaded', fetchCheckins);
    </script>
</body>
</html>